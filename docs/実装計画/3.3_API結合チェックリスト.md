# 3.3 API結合チェックリスト

WBS「3.実装 > 3.3 API結合」の実装タスク一覧

**目的**: 3.2フェーズで実装したモックベースの画面を、実際のHotPepper API（内部API経由）と結合し、動的なデータ表示を実現する。

**前提条件**:

- 3.1フェーズ（共通実装）が完了していること
- 3.2フェーズ（画面実装）が完了していること

---

## 0. 環境準備

### 0.1 APIキー取得

- [x] HotPepper Gourmet API キー取得
  - [x] [リクルートWebサービス](https://webservice.recruit.co.jp/)にアクセス
  - [x] 新規会員登録（未登録の場合）
  - [x] ログイン後、「新しいアプリケーションを追加」
  - [x] APIキーを発行（HotPepper Gourmet API v1を選択）
- [x] Google Maps JavaScript API キー取得
  - [x] [Google Cloud Console](https://console.cloud.google.com/)にアクセス
  - [x] 新規プロジェクト作成（未作成の場合）
  - [x] 「APIとサービス > ライブラリ」から「Maps JavaScript API」を有効化
  - [x] 「APIとサービス > 認証情報」からAPIキーを作成
  - [x] APIキーの制限設定（推奨）
    - アプリケーションの制限：HTTPリファラー
    - APIの制限：Maps JavaScript API

### 0.2 環境変数設定

- [x] `.env`ファイル作成・更新
  - [x] `.env.example`を`.env`にコピー（未作成の場合）
  - [x] `NUXT_HOTPEPPER_API_KEY`に取得したHotPepper APIキーを設定
  - [x] `NUXT_PUBLIC_GOOGLE_MAPS_API_KEY`に取得したGoogle Maps APIキーを設定
  - [x] その他の環境変数を必要に応じて設定（`NUXT_LOG_LEVEL`等）
- [x] 開発サーバー再起動
  - [x] `yarn dev`を再起動して環境変数を読み込む
  - [x] コンソールでエラーが出ていないことを確認

---

## 1. TOPページAPI結合

### 1.1 マスタデータ取得

- [x] `app/pages/index.vue` 更新
  - [x] モックデータ（`mockGenres`, `mockLargeAreas`, `mockMiddleAreas`, `mockSmallAreas`）を削除
  - [x] `useMasters()` composableを使ってマスタデータを取得
  - [x] ローディング状態の表示（スケルトンUI）
  - [x] エラー時の表示（エラーメッセージ）

### 1.2 周辺店舗データ取得

- [x] `app/pages/index.vue` 更新
  - [x] `handleLocationObtained` 関数を更新
    - [x] モックデータ生成処理を削除
    - [x] `useShopSearch()` composableで位置情報検索APIを呼び出し
      - **実装方針**: `useShopSearch`を拡張して`server`/`immediate`オプションをサポート
      - CSR専用実行: `useShopSearch(params, { server: false, immediate: false })`
      - プロジェクトの既存パターン（composableファイルでロジックをカプセル化）に準拠
    - [x] 位置情報（lat, lng）をパラメータとして渡す
    - [x] 検索結果を`nearbyShops`に設定
  - [x] エラーハンドリング（API失敗時の表示）
    - [x] エラーメッセージの表示
    - [x] リトライ機能の実装

### 1.3 結合テスト

- [x] `tests/pages/index.test.ts` 作成（新規ファイル）
  - [x] マスタデータ取得の確認（composableモック）
  - [x] 位置情報取得〜店舗検索の一連の流れ
  - [x] ローディング状態の表示確認
  - [x] エラー時の表示確認
  - **実装方針**: composableをモックする方式を採用（既存テストパターンとの一貫性、保守性を考慮）
  - **テスト内容**: ページレベルの統合テスト（子コンポーネントの詳細は各コンポーネントテストで実施）

---

## 2. 検索結果ページAPI結合

### 2.1 マスタデータ取得

- [ ] `app/pages/shops/index.vue` 更新
  - [ ] モックデータを削除
  - [ ] `useMasters()` composableを使ってマスタデータを取得
  - [ ] ローディング状態の表示
  - [ ] エラー時の表示

### 2.2 店舗検索API呼び出し

- [ ] `app/pages/shops/index.vue` 更新
  - [ ] モックデータ生成処理（`generateMockShops`）を削除
  - [ ] `useShopSearch()` composableで検索APIを呼び出し
  - [ ] URLクエリパラメータ（`q`, `genres`, `area_l`, `area_m`, `area_s`, `page`）を渡す
  - [ ] 検索結果と`pagination`情報を取得
  - [ ] ローディング状態の表示（`ResultList`のスケルトン）
  - [ ] 0件時の表示
  - [ ] エラー時の表示

### 2.3 ページネーション処理

- [ ] `app/pages/shops/index.vue` 更新
  - [ ] `handlePageUpdate` 関数を更新
    - [ ] モック実装を削除
    - [ ] URLクエリの`page`パラメータを更新
    - [ ] `navigateTo`で同じページに遷移（クエリのみ更新）
    - [ ] ページ遷移時にスクロール位置をトップに移動

### 2.4 結合テスト

- [ ] `tests/pages/shops/index.test.ts` に追記（既存ファイル）
  - [ ] マスタデータ取得の確認（MSWでモック）
  - [ ] URLクエリからの検索パラメータ取得
  - [ ] 検索API呼び出しと結果表示
  - [ ] ページネーション動作
  - [ ] ローディング状態の表示確認
  - [ ] エラー時の表示確認

---

## 3. 詳細ページAPI結合

### 3.1 店舗詳細データ取得

- [ ] `app/pages/shops/[id].vue` 更新
  - [ ] モックデータ（`mockShopDetail`）を削除
  - [ ] `useShopDetail()` composableで店舗詳細APIを呼び出し
  - [ ] URLパラメータ`id`を渡す
  - [ ] 取得した店舗詳細データを`shop`に設定
  - [ ] ローディング状態の表示（スケルトンUI）
  - [ ] 404エラー時の処理（`createError({ statusCode: 404 })`）
  - [ ] その他エラー時の表示

### 3.2 結合テスト

- [ ] `tests/pages/shops/[id].test.ts` に追記（既存ファイル）
  - [ ] 店舗詳細データ取得の確認（MSWでモック）
  - [ ] 店舗情報の表示確認
  - [ ] ローディング状態の表示確認
  - [ ] 404エラー時の動作確認
  - [ ] その他エラー時の表示確認

---

## 4. 完了条件

- [ ] すべてのチェック項目が完了
- [ ] 結合テストがパス（`yarn test`）
- [ ] 型チェックがパス（`yarn type-check`）
- [ ] Lintエラーなし（`yarn lint`）
- [ ] Stylelintエラーなし（`yarn lint:css`）
- [ ] 開発サーバーで全画面が正しく動作することを確認
  - [ ] TOPページ: マスタデータと周辺店舗が正しく表示される
  - [ ] 検索結果ページ: 検索条件に応じた店舗が表示される
  - [ ] 詳細ページ: 店舗詳細が正しく表示される
  - [ ] ページネーションが正しく動作する
  - [ ] エラー時に適切なメッセージが表示される

---

## 注意事項

- **MSWの活用**: 結合テストではMSW（Mock Service Worker）を使って内部APIをモック化する
- **エラーハンドリング**: API失敗時やネットワークエラー時に、ユーザーフレンドリーなエラーメッセージを表示する
- **ローディング状態**: データ取得中は適切なローディングUIを表示し、UXを向上させる
- **SEO**: サーバーサイドでデータを取得し、SEO最適化を維持する（`useFetch`や`useAsyncData`を活用）
