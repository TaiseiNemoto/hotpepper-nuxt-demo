# 3.3 API結合チェックリスト

WBS「3.実装 > 3.3 API結合」の実装タスク一覧

**目的**: 3.2フェーズで実装したモックベースの画面を、実際のHotPepper API（内部API経由）と結合し、動的なデータ表示を実現する。

**前提条件**:

- 3.1フェーズ（共通実装）が完了していること
- 3.2フェーズ（画面実装）が完了していること

---

## 0. 環境準備

### 0.1 APIキー取得

- [x] HotPepper Gourmet API キー取得
  - [x] [リクルートWebサービス](https://webservice.recruit.co.jp/)にアクセス
  - [x] 新規会員登録（未登録の場合）
  - [x] ログイン後、「新しいアプリケーションを追加」
  - [x] APIキーを発行（HotPepper Gourmet API v1を選択）
- [x] Google Maps JavaScript API キー取得
  - [x] [Google Cloud Console](https://console.cloud.google.com/)にアクセス
  - [x] 新規プロジェクト作成（未作成の場合）
  - [x] 「APIとサービス > ライブラリ」から「Maps JavaScript API」を有効化
  - [x] 「APIとサービス > 認証情報」からAPIキーを作成
  - [x] APIキーの制限設定（推奨）
    - アプリケーションの制限：HTTPリファラー
    - APIの制限：Maps JavaScript API

### 0.2 環境変数設定

- [x] `.env`ファイル作成・更新
  - [x] `.env.example`を`.env`にコピー（未作成の場合）
  - [x] `NUXT_HOTPEPPER_API_KEY`に取得したHotPepper APIキーを設定
  - [x] `NUXT_PUBLIC_GOOGLE_MAPS_API_KEY`に取得したGoogle Maps APIキーを設定
  - [x] その他の環境変数を必要に応じて設定（`NUXT_LOG_LEVEL`等）
- [x] 開発サーバー再起動
  - [x] `yarn dev`を再起動して環境変数を読み込む
  - [x] コンソールでエラーが出ていないことを確認

---

## 1. TOPページAPI結合

### 1.1 マスタデータ取得

- [x] `app/pages/index.vue` 更新
  - [x] モックデータ（`mockGenres`, `mockLargeAreas`, `mockMiddleAreas`, `mockSmallAreas`）を削除
  - [x] `useMasters()` composableを使ってマスタデータを取得
  - [x] ローディング状態の表示（スケルトンUI）
  - [x] エラー時の表示（エラーメッセージ）

### 1.2 周辺店舗データ取得

- [x] `app/pages/index.vue` 更新
  - [x] `handleLocationObtained` 関数を更新
    - [x] モックデータ生成処理を削除
    - [x] `useShopSearch()` composableで位置情報検索APIを呼び出し
      - **実装方針**: `useShopSearch`を拡張して`server`/`immediate`オプションをサポート
      - CSR専用実行: `useShopSearch(params, { server: false, immediate: false })`
      - プロジェクトの既存パターン（composableファイルでロジックをカプセル化）に準拠
    - [x] 位置情報（lat, lng）をパラメータとして渡す
    - [x] 検索結果を`nearbyShops`に設定
  - [x] エラーハンドリング（API失敗時の表示）
    - [x] エラーメッセージの表示
    - [x] リトライ機能の実装

### 1.3 結合テスト

- [x] `tests/pages/index.test.ts` 作成（新規ファイル）
  - [x] マスタデータ取得の確認（composableモック）
  - [x] 位置情報取得〜店舗検索の一連の流れ
  - [x] ローディング状態の表示確認
  - [x] エラー時の表示確認
  - **実装方針**: composableをモックする方式を採用（既存テストパターンとの一貫性、保守性を考慮）
  - **テスト内容**: ページレベルの統合テスト（子コンポーネントの詳細は各コンポーネントテストで実施）

---

## 2. 検索結果ページAPI結合

### 2.1 マスタデータ取得

- [x] `app/pages/shops/index.vue` 更新
  - [x] モックデータを削除
  - [x] 個別composable（`useGenres`, `useLargeAreas`, `useMiddleAreas`, `useSmallAreas`）を使ってマスタデータを取得
  - [x] ローディング状態の表示
  - [x] エラー時の表示
  - **実装方針**: TOPページと同じパターンで個別composableを使用（プロジェクトの一貫性を優先）

### 2.2 店舗検索API呼び出し

- [x] `app/pages/shops/index.vue` 更新
  - [x] モックデータ生成処理（`generateMockShops`）を削除
  - [x] `useShopSearch()` composableで検索APIを呼び出し
  - [x] URLクエリパラメータ（`q`, `genres`, `area_l`, `area_m`, `area_s`, `page`）をパラメータにマッピング
  - [x] 検索結果と`pagination`情報を取得
  - [x] ローディング状態の表示（`ResultList`のスケルトン）
  - [x] 0件時の表示
  - [x] エラー時の表示（再試行ボタン付き）
  - **実装方針**: SSR + 自動リフェッチ（`server: true`, `immediate: true`, `watch: [query]`）

### 2.3 ページネーション処理

- [x] `app/pages/shops/index.vue` 更新
  - [x] `handlePageUpdate` 関数を更新
    - [x] モック実装を削除
    - [x] URLクエリの`page`パラメータを更新
    - [x] `navigateTo`で同じページに遷移（クエリのみ更新）
  - **実装方針**: 2.2と統合実装（`useShopSearch`の`watch`機能により自動的にリフェッチされるため）

### 2.4 結合テスト

- [x] `tests/pages/shops/index.test.ts` に追記（既存ファイル）
  - [x] マスタデータ取得の確認（composableモック）
  - [x] URLクエリからの検索パラメータ取得
  - [x] 検索API呼び出しと結果表示
  - [x] ローディング状態の表示確認
  - [x] 0件時の表示確認
  - [x] エラー時の表示確認
  - [x] 再試行ボタンの動作確認
  - **実装方針**: `mockNuxtImport`でcomposableをモック（既存パターンとの一貫性）
  - **追加テスト**: 6個のテストケースを追加（合計19個のテストがパス）

---

## 3. 詳細ページAPI結合

### 3.1 店舗詳細データ取得

- [x] `app/pages/shops/[id].vue` 更新
  - [x] モックデータ（`mockShopDetail`）を削除
  - [x] `useShopDetail()` composableで店舗詳細APIを呼び出し
  - [x] URLパラメータ`id`を渡す
  - [x] 取得した店舗詳細データを`shop`に設定
  - [x] ローディング状態の表示（スケルトンUI）
  - [x] 404エラー時の処理（`createError({ statusCode: 404 })`）
  - [x] その他エラー時の表示（エラーメッセージ + 再試行ボタン）

### 3.2 結合テスト

- [x] `tests/pages/shops/[id].test.ts` に追記（既存ファイル）
  - [x] 店舗詳細データ取得の確認（composableモック）
  - [x] 店舗情報の表示確認
  - [x] ローディング状態の表示確認
  - [x] ~~404エラー時の動作確認~~（※単体テストでは適切にテストできないため、E2Eテストで確認）
  - [x] その他エラー時の表示確認
  - [x] 再試行ボタンの動作確認
  - [x] 公式URLの条件付き表示確認
  - [x] 位置情報の条件付き表示確認
  - **実装方針**: `mockNuxtImport`でcomposableをモック（既存パターンとの一貫性）
  - **追加テスト**: 8個のテストケースを実装（すべてパス）

---

## 4. 完了条件

- [x] すべてのチェック項目が完了
- [x] 結合テストがパス（`yarn test`）※151/152テストがパス（失敗1件は既存の無関係なテスト）
- [x] 型チェックがパス（`yarn type-check`）
- [x] Lintエラーなし（`yarn lint`）
- [x] Stylelintエラーなし（`yarn lint:css`）
- [ ] 開発サーバーで全画面が正しく動作することを確認
  - [x] TOPページ: マスタデータと周辺店舗が正しく表示される
  - [x] 検索結果ページ: 検索条件に応じた店舗が表示される
  - [ ] 詳細ページ: 店舗詳細が正しく表示される ※実際の動作確認は未実施
  - [x] ページネーションが正しく動作する
  - [x] エラー時に適切なメッセージが表示される

---

## 注意事項

- **MSWの活用**: 結合テストではMSW（Mock Service Worker）を使って内部APIをモック化する
- **エラーハンドリング**: API失敗時やネットワークエラー時に、ユーザーフレンドリーなエラーメッセージを表示する
- **ローディング状態**: データ取得中は適切なローディングUIを表示し、UXを向上させる
- **SEO**: サーバーサイドでデータを取得し、SEO最適化を維持する（`useFetch`や`useAsyncData`を活用）
