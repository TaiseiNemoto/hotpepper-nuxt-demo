# 3.1 共通実装チェックリスト

WBS「3.実装 > 3.1共通実装」の実装タスク一覧（推奨実装順）

---

## 1. テスト環境構築

### 1.1 テストツール導入

- [x] Vitest セットアップ
  - [x] `vitest.config.ts` 作成 (@nuxt/test-utils 使用)
  - [x] `package.json` にテストスクリプト追加
  - [x] `nuxt.config.ts` に @nuxt/test-utils/module 追加
- [x] @vue/test-utils セットアップ (@nuxt/test-utils に含まれる)
- [x] MSW（Mock Service Worker）セットアップ
  - [x] `tests/mocks/handlers.ts`: API モックハンドラー定義
  - [x] `tests/mocks/server.ts`: MSW サーバー設定

### 1.2 テストデータ準備

- [x] `tests/fixtures/shops.ts`: 店舗データフィクスチャ
- [x] `tests/fixtures/masters.ts`: マスタデータフィクスチャ
- [x] `tests/fixtures/errors.ts`: エラーレスポンスフィクスチャ

---

## 2. ログ出力実装（サーバーサイド）

### 2.1 ログユーティリティ

- [ ] `server/utils/logger.ts`: ログ出力基盤
  - ログレベル（DEBUG/INFO/WARN/ERROR/FATAL）
  - カテゴリ（ACCESS/SSR/API/SYSTEM）
  - フォーマット：`[timestamp] [level] [category] message`
  - 環境変数対応：`NUXT_LOG_LEVEL`, `NUXT_LOG_ENABLE_ACCESS`
  - 出力先振り分け（INFO/WARN → stdout, ERROR/FATAL → stderr）

### 2.2 ログ出力テスト

- [ ] `server/utils/logger.test.ts`: ログユーティリティのテスト
  - レベルフィルタリング
  - フォーマット検証
  - 環境変数による動作変更

### 2.3 ログ統合

- [ ] `server/middleware/access-log.ts`: アクセスログミドルウェア
  - リクエスト受付時に `[ACCESS] GET /path` を出力
- [ ] `server/middleware/access-log.test.ts`: アクセスログミドルウェアのテスト

---

## 3. API実装（サーバーサイド）

### 3.1 共通基盤

- [ ] 型定義ファイル作成
  - [ ] `server/types/api.ts`: 共通API型（`ApiResult<T>`, `ApiError`, `ErrorCode`）
  - [ ] `server/types/hotpepper.ts`: HotPepper API レスポンス型
- [ ] ユーティリティ実装
  - [ ] `server/utils/hotpepper-client.ts`: HotPepper API クライアント基底実装
    - 環境変数 `NUXT_HOTPEPPER_API_KEY` の取得
    - 共通リクエストヘッダー設定
    - エラーハンドリング（4xx/5xx → `ApiError` 変換）
    - 再試行ロジック（通信エラー時1回まで）
    - ログ出力統合（API呼び出し開始/成功/失敗/再試行）

### 3.2 内部API実装（HP-01〜HP-06）

- [ ] `server/api/hp/shops/search.get.ts`: HP-01 店舗検索
  - クエリパラメータのバリデーション・正規化
  - HotPepper API呼び出し
  - レスポンス変換（`SearchResponse` / `ShopSummary`）
- [ ] `server/api/hp/shops/[id].get.ts`: HP-02 店舗詳細取得
  - パスパラメータのバリデーション
  - HotPepper API呼び出し
  - レスポンス変換（`ShopDetail`）
- [ ] `server/api/hp/genres.get.ts`: HP-03 ジャンルマスタ取得
  - HotPepper API呼び出し
  - レスポンス変換（`Genre[]`）
- [ ] `server/api/hp/areas/large.get.ts`: HP-04 大エリアマスタ取得
  - HotPepper API呼び出し
  - レスポンス変換（`LargeArea[]`）
- [ ] `server/api/hp/areas/middle.get.ts`: HP-05 中エリアマスタ取得
  - クエリパラメータ（`largeAreaCode`）のバリデーション
  - HotPepper API呼び出し
  - レスポンス変換（`MiddleArea[]`）
- [ ] `server/api/hp/areas/small.get.ts`: HP-06 小エリアマスタ取得
  - クエリパラメータ（`middleAreaCode`）のバリデーション
  - HotPepper API呼び出し
  - レスポンス変換（`SmallArea[]`）

### 3.3 API単体テスト

- [ ] `server/api/hp/shops/search.get.test.ts`: HP-01テスト
  - 正常系：パラメータ正規化、レスポンス変換
  - 異常系：バリデーションエラー、上流エラー
- [ ] `server/api/hp/shops/[id].get.test.ts`: HP-02テスト
- [ ] `server/api/hp/genres.get.test.ts`: HP-03テスト
- [ ] `server/api/hp/areas/large.get.test.ts`: HP-04テスト
- [ ] `server/api/hp/areas/middle.get.test.ts`: HP-05テスト
- [ ] `server/api/hp/areas/small.get.test.ts`: HP-06テスト

---

## 4. APIクライアント基盤実装（フロントエンド）

### 4.1 型定義

- [ ] `types/api.ts`: クライアント用API型（`ApiResult<T>`, `ApiError`, `ErrorCode`）
- [ ] `types/shop.ts`: 店舗関連型（`ShopSummary`, `ShopDetail`）
- [ ] `types/master.ts`: マスタ関連型（`Genre`, `LargeArea`, `MiddleArea`, `SmallArea`）

### 4.2 Composables実装

- [ ] `composables/useApi.ts`: 内部API呼び出し共通ロジック
  - `useFetch` / `$fetch` のラッパー
  - エラーハンドリング（`ApiResult<T>` 型チェック）
  - ローディング状態管理
- [ ] `composables/useShopSearch.ts`: HP-01呼び出し用
- [ ] `composables/useShopDetail.ts`: HP-02呼び出し用
- [ ] `composables/useMasters.ts`: HP-03〜HP-06呼び出し用

### 4.3 Composables単体テスト

- [ ] `composables/useApi.test.ts`: 共通ロジックのテスト
- [ ] `composables/useShopSearch.test.ts`: HP-01呼び出しテスト（MSWでモック）
- [ ] `composables/useShopDetail.test.ts`: HP-02呼び出しテスト
- [ ] `composables/useMasters.test.ts`: HP-03〜HP-06呼び出しテスト

---

## 5. ドキュメント・設定

- [ ] `docs/実装計画/3.1_共通実装チェックリスト.md`: このファイル
- [ ] `.env.example` 更新確認（API鍵の記載確認）
- [ ] `README.md` 更新確認（テスト実行方法の追記）

---

## 完了条件

- [ ] すべてのチェック項目が完了
- [ ] すべてのテストがパス（`yarn test`）
- [ ] 型チェックがパス（`yarn type-check`）
- [ ] Lintエラーなし（`yarn lint`）
- [ ] ログ出力が設計仕様どおりに動作することを確認
