# 3.1 共通実装チェックリスト

WBS「3.実装 > 3.1共通実装」の実装タスク一覧（推奨実装順）

---

## 1. テスト環境構築

### 1.1 テストツール導入

- [x] Vitest セットアップ
  - [x] `vitest.config.ts` 作成 (@nuxt/test-utils 使用)
  - [x] `package.json` にテストスクリプト追加
  - [x] `nuxt.config.ts` に @nuxt/test-utils/module 追加
- [x] @vue/test-utils セットアップ (@nuxt/test-utils に含まれる)
- [x] MSW（Mock Service Worker）セットアップ
  - [x] `tests/mocks/handlers.ts`: API モックハンドラー定義
  - [x] `tests/mocks/server.ts`: MSW サーバー設定

### 1.2 テストデータ準備

- [x] `tests/fixtures/shops.ts`: 店舗データフィクスチャ
- [x] `tests/fixtures/masters.ts`: マスタデータフィクスチャ
- [x] `tests/fixtures/errors.ts`: エラーレスポンスフィクスチャ

---

## 2. ログ出力実装（サーバーサイド）

### 2.1 ログユーティリティ（Nitroプラグインベース）

- [x] `server/plugins/logger.ts`: Nitroプラグインベースのログ出力基盤
  - **ロガー初期化**
    - ログレベル（DEBUG/INFO/WARN/ERROR/FATAL）
    - カテゴリ（ACCESS/SSR/API/SYSTEM）
    - フォーマット：`[timestamp] [level] [category] message [metadata]`
    - タイムスタンプ：JST（ISO8601形式、例: `2025-11-05T19:30:45+09:00`）
    - 環境変数対応：`runtimeConfig`経由で`NUXT_LOG_LEVEL`, `NUXT_LOG_ENABLE_ACCESS`を取得
    - 出力先振り分け（INFO/WARN → stdout, ERROR/FATAL → stderr）
  - **イベントコンテキストへの共有**
    - `event.context.logger`にロガーインスタンスを設定
  - **Nitroフック実装**
    - `request`フック: アクセスログ出力（`[ACCESS] GET /path`）
    - `beforeResponse`フック: SSR処理完了ログ（オプション）
    - `error`フック: エラーログ出力
  - **カテゴリ別ロガー**
    - `logger.withCategory('API')` でカテゴリ固定ロガーを取得
    - 各カテゴリで追加情報（メタデータ）を付与可能

### 2.2 ログ出力テスト

- [x] `tests/server/plugins/logger.test.ts`: ログユーティリティのテスト（40テスト）
  - [x] レベルフィルタリング（minLevelによるフィルタリング動作）
  - [x] フォーマット検証（JSTタイムスタンプ含む）
  - [x] ユーティリティ関数テスト（`resolveLogLevel`, `resolveBoolean`, `formatTimestampJst`, `formatMetadata`）
  - [x] カテゴリ別ロガーの動作確認（`withCategory`）
  - [x] メタデータマージの動作確認（`withMetadata`）
  - [x] `NitroLogger`クラスの各メソッド（debug/info/warn/error/fatal）
  - ~~Nitroフックの動作確認（request/beforeResponse/error）~~
    - **注**: Nitroフック統合テストは`@nuxt/test-utils`の制約により複雑すぎるためスキップ
    - 実サーバー起動での手動確認に任せる
- [x] `server/utils/logger-utils.ts`: テスト可能な関数・クラスを分離

---

## 3. API実装（サーバーサイド）

### 3.1 共通基盤

- [x] 型定義ファイル作成
  - [x] `server/types/api.ts`: 共通API型（`ApiResult<T>`, `ApiError`, `ErrorCode`）
  - [x] `server/types/hotpepper.ts`: HotPepper API レスポンス型
  - [x] `server/types/hp-internal.ts`: 内部API型（`ShopSummary`, `ShopDetail`, `*Response`）
- [x] ユーティリティ実装
  - [x] `server/utils/hotpepper-client.ts`: HotPepper API クライアント基底実装
    - 環境変数 `NUXT_HOTPEPPER_API_KEY` の取得
    - 共通リクエストヘッダー設定
    - エラーハンドリング（4xx/5xx → `ApiError` 変換）
    - 再試行ロジック（通信エラー時1回まで）
    - ログ出力統合（API呼び出し開始/成功/失敗/再試行）
    - JSDocコメント追加（クラス、publicメソッド、インターフェース）
  - [x] `server/utils/api-response.ts`: エラーレスポンスヘルパー
    - `ValidationError`クラス
    - `respondWithValidationError`関数
    - `respondWithUpstreamError`関数
    - JSDocコメント追加
  - [x] `server/utils/hp-transformers.ts`: HotPepperレスポンス変換関数
    - `toShopSummary`, `toShopDetail`
    - `toSearchResponse`, `toGenresResponse`
    - `toLargeAreasResponse`, `toMiddleAreasResponse`, `toSmallAreasResponse`
    - JSDocコメント追加
  - [x] `server/utils/validation.ts`: バリデーション共通ユーティリティ
    - `normalizeCode`関数（エリアコード・ジャンルコード正規化）
    - `toRecord`関数
    - JSDocコメント追加

### 3.2 内部API実装（HP-01〜HP-06）

- [x] `server/api/hp/shops/search.get.ts`: HP-01 店舗検索
  - クエリパラメータのバリデーション・正規化
  - HotPepper API呼び出し
  - レスポンス変換（`SearchResponse` / `ShopSummary`）
- [x] `server/api/hp/shops/[id].get.ts`: HP-02 店舗詳細取得
  - パスパラメータのバリデーション
  - HotPepper API呼び出し
  - レスポンス変換（`ShopDetail`）
  - NOT_FOUND時に404ステータスコード設定
- [x] `server/api/hp/genres.get.ts`: HP-03 ジャンルマスタ取得
  - HotPepper API呼び出し
  - レスポンス変換（`Genre[]`）
- [x] `server/api/hp/areas/large.get.ts`: HP-04 大エリアマスタ取得
  - HotPepper API呼び出し
  - レスポンス変換（`LargeArea[]`）
- [x] `server/api/hp/areas/middle.get.ts`: HP-05 中エリアマスタ取得
  - クエリパラメータ（`largeAreaCode`）のバリデーション
  - HotPepper API呼び出し
  - レスポンス変換（`MiddleArea[]`）
- [x] `server/api/hp/areas/small.get.ts`: HP-06 小エリアマスタ取得
  - クエリパラメータ（`middleAreaCode`）のバリデーション
  - HotPepper API呼び出し
  - レスポンス変換（`SmallArea[]`）

### 3.3 API単体テスト

#### 3.3.1 方針 / Nuxtベストプラクティス

- [x] `tests/server/api/hp/` 配下に API ごとの spec を配置し、各ファイルの先頭で `// @vitest-environment nuxt` を宣言して Nuxt runtime を有効化。
- [x] API 単体テストでは `createHotpepperClient` を `vi.mock` で差し替え、MSW は UI/結合テスト専用として運用しつつ、外部 API 実呼び出しを完全に遮断。
- [x] `vi.mock('../../../../server/utils/hotpepper-client')` で戻り値を `createSuccessResult` / `createFailureResult` で制御し、決定論的にシナリオを再現。
- [x] `tests/utils/createTestEvent.ts` を新設し、`createEvent` をラップして `path` / `query` / `params` / `context` をまとめて注入するテスト専用イベントを生成。
- [x] レスポンス本体だけでなく `event.node.res.statusCode` も必ず検証し、`respondWithValidationError`（400）・`setResponseStatus`（404）・`respondWithUpstreamError`（API エラーコード）の副作用を保証。
- [x] HotPepper 生データのモックは `tests/fixtures/hotpepper.ts` に集約し、`describe()` / `it()` の説明文・コメントは日本語で統一。

#### 3.3.2 API ごとのチェックリスト

- [x] `server/api/hp/shops/search.get.test.ts`: HP-01 検索 API
  - [x] HotPepper 検索結果（`mockHpSearchResults`）を入力し、`toSearchResponse` がラップされた `createSuccessResult` で返ることを検証。
  - [x] `page` / `perPage` / `count` / `start` の相互計算と 100 件上限の丸め込み、位置検索時の `order` 固定・`range` 補完をテーブル化。
  - [x] キーワード・エリア系マルチパラメータの正規化（カンマ区切り・重複・上限値）と `lat`/`lng`/`range` の整合性バリデーションを網羅。
  - [x] 上流エラー（`createFailureResult`）、0 件応答（`mockHpSearchResultsEmpty`）がそれぞれ想定どおりのステータス／ボディになることを確認。

- [x] `server/api/hp/shops/[id].get.test.ts`: HP-02 詳細 API
  - [x] `mockHpSearchResults` から `toShopDetail` を適用し、`shop` フィールドに格納される正常系を確認。
  - [x] ルーターパラメータ未指定・空文字のバリデーション、`NOT_FOUND` エラー／空配列時の 404 + `{ notFound: true }` 応答を検証。
  - [x] `UPSTREAM_ERROR` などその他エラーは `respondWithUpstreamError` の戻り値とステータスを透過することを確認。

- [x] `server/api/hp/genres.get.test.ts`: HP-03 ジャンル API
  - [x] `mockHpGenreResults` → `toGenresResponse` → `createSuccessResult` の経路を検証。
  - [x] エラー時は `createFailureResult(mockApiError.error)` をそのまま返し、HTTP 502 がセットされることを確認。

- [x] `server/api/hp/areas/large.get.test.ts`: HP-04 大エリア API
  - [x] `mockHpLargeAreaResults` を `toLargeAreasResponse` へ通し、成功レスポンスを確認。
  - [x] HotPepper 失敗時に 5xx（デフォルト 502）が返ることを確認。

- [x] `server/api/hp/areas/middle.get.test.ts`: HP-05 中エリア API
  - [x] クエリ無しでは全件、`largeAreaCode` 指定時は `{ large_area: code }` を `getMiddleAreas` に渡すことを確認。
  - [x] `largeAreaCode` が配列／文字数超過など不正な場合に 400 を返し、上流エラーは 5xx で透過することを検証。

- [x] `server/api/hp/areas/small.get.test.ts`: HP-06 小エリア API
  - [x] `middleAreaCode` を必須として `{ middle_area: code }` を `getSmallAreas` に連携する正常系を確認。
  - [x] `middleAreaCode` 未指定・空文字・配列などのバリデーションと、上流エラー時の 5xx 伝播を検証。

---

## 4. APIクライアント基盤実装（フロントエンド）

### 4.1 型定義

- [ ] `types/api.ts`: クライアント用API型（`ApiResult<T>`, `ApiError`, `ErrorCode`）
- [ ] `types/shop.ts`: 店舗関連型（`ShopSummary`, `ShopDetail`）
- [ ] `types/master.ts`: マスタ関連型（`Genre`, `LargeArea`, `MiddleArea`, `SmallArea`）

### 4.2 Composables実装

- [ ] `composables/useApi.ts`: 内部API呼び出し共通ロジック
  - `useFetch` / `$fetch` のラッパー
  - エラーハンドリング（`ApiResult<T>` 型チェック）
  - ローディング状態管理
- [ ] `composables/useShopSearch.ts`: HP-01呼び出し用
- [ ] `composables/useShopDetail.ts`: HP-02呼び出し用
- [ ] `composables/useMasters.ts`: HP-03〜HP-06呼び出し用

### 4.3 Composables単体テスト

- [ ] `composables/useApi.test.ts`: 共通ロジックのテスト
- [ ] `composables/useShopSearch.test.ts`: HP-01呼び出しテスト（MSWでモック）
- [ ] `composables/useShopDetail.test.ts`: HP-02呼び出しテスト
- [ ] `composables/useMasters.test.ts`: HP-03〜HP-06呼び出しテスト

---

## 5. ドキュメント・設定

- [ ] `docs/実装計画/3.1_共通実装チェックリスト.md`: このファイル
- [ ] `.env.example` 更新確認（API鍵の記載確認）
- [ ] `README.md` 更新確認（テスト実行方法の追記）

---

## 完了条件

- [ ] すべてのチェック項目が完了
- [ ] すべてのテストがパス（`yarn test`）
- [ ] 型チェックがパス（`yarn type-check`）
- [ ] Lintエラーなし（`yarn lint`）
- [ ] ログ出力が設計仕様どおりに動作することを確認
