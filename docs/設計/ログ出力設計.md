## ログの目的と分類
### 目的
サーバー（Nitro）処理における状態・異常を把握し、  不具合調査・障害対応・API通信状況の確認を可能にする。
### 分類
#### ログレベル
| レベル       | 用途         | 例                 |
| --------- | ---------- | ----------------- |
| **INFO**  | 正常処理の要点を記録 | APIリクエスト成功、SSR完了  |
| **WARN**  | 想定内の軽微な異常  | 上流APIの部分エラー、再試行発生 |
| **ERROR** | 想定外の失敗     | 上流APIエラー、例外キャッチ   |
| **FATAL** | 致命的な失敗     | SSR全体失敗、環境変数欠如など  |
#### 出力単位
|カテゴリ|対象|
|---|---|
|**API**|上流API呼び出し、内部API通信|
|**SSR**|サーバー描画処理（ページ初期化）|
|**SYSTEM**|アプリ起動・環境関連・未処理例外|

---
## 出力対象・タイミング
### 基本方針
- SSR（Nitroサーバー）で発生する処理を対象とする。
- 主目的は **障害調査・API通信の追跡・SSR状態確認**。

### 出力対象一覧
|区分|出力タイミング|レベル|例|
|---|---|---|---|
|**ページリクエスト受付**|SSRリクエスト受信時（各ページアクセス）|INFO|`[ACCESS] GET /shops?page=2`|
|**SSR処理完了**|SSR描画が正常に完了した時点|INFO|`[SSR] render complete: /shops?page=2 (842ms)`|
|**SSR処理失敗**|SSR初期データ取得・描画に失敗した場合|FATAL|`[SSR] render failed: /shops?page=2 (error=HP-01 fetch failed)`|
|**API呼び出し開始**|上流HotPepper API呼び出し直前|DEBUG|`[API] HP-01 request start (params: page=1, perPage=20)`|
|**API呼び出し成功**|上流APIが200系レスポンスを返却|INFO|`[API] HP-01 success (status=200, duration=420ms)`|
|**API呼び出し失敗**|上流APIが4xx/5xx応答を返却|ERROR|`[API] HP-01 failed (status=500, message=Internal Error)`|
|**再試行実施**|API再試行ルールが発動した場合|WARN|`[API] HP-01 retry (1/3)`|
|**システム異常**|環境変数不足、初期化失敗など|FATAL|`[SYSTEM] Missing env HOTPEPPER_API_KEY`|
|**未捕捉例外**|想定外の例外キャッチ|ERROR|`[SYSTEM] Unhandled exception: [Error message]`|
### 補足ルール
- **ACCESSログ**は最上流に1件のみ出力（全SSR共通middlewareで処理）。
- **DEBUGログ**は開発環境のみ有効。
- **API系ログ**は内部API `/api/hp/...` 単位で共通ラッパから出力。
- **FATAL発生時**は、メッセージ＋スタックトレースを出力。

---
## 出力内容（項目定義
### 共通フィールド
|フィールド|用途|
|---|---|
|`timestamp`|出力時刻（ISO形式）|
|`level`|ログレベル（INFO / WARN / ERROR / FATAL）|
|`category`|種別（ACCESS / SSR / API / SYSTEM）|
|`message`|要約メッセージ（人間が読める内容）|
### カテゴリ別追加フィールド
|カテゴリ|追加項目|備考|
|---|---|---|
|ACCESS|`method`, `path`|ページアクセス把握用（リクエスト開始ログ）|
|SSR|`route`, `durationMs?`, `status?`|SSR処理の結果と時間|
|API|`apiName`, `status`, `durationMs?`|上流呼び出し結果|
|SYSTEM|`detail?`|環境異常・例外概要など|
### 出力例
```pgsql
[2025-10-30T10:05:31.501Z] [INFO] [ACCESS] GET /shops?page=2
[2025-10-30T10:05:32.343Z] [INFO] [SSR] render complete /shops (842ms)
[2025-10-30T10:05:32.120Z] [INFO] [API] HP-01 success (status=200, 420ms)
[2025-10-30T10:05:35.002Z] [FATAL] [SYSTEM] Missing env HOTPEPPER_API_KEY
```

---
## 出力フォーマット
### 基本
- 形式：`[<timestamp>] [<level>] [<category>] <message>`
- 例：
    - `[2025-10-30T10:05:31.501Z] [INFO] [ACCESS] GET /shops`
    - `[2025-10-30T10:05:32.343Z] [INFO] [SSR] render complete /shops (842ms)`
    - `[2025-10-30T10:05:32.120Z] [INFO] [API] HP-01 success (status=200, 420ms)`
    - `[2025-10-30T10:05:35.002Z] [FATAL] [SYSTEM] Missing env HOTPEPPER_API_KEY`

### プレースホルダー
- `timestamp`: ISO8601（UTC, `Z` 付き）
- `level`: `DEBUG|INFO|WARN|ERROR|FATAL`
- `category`: `ACCESS|SSR|API|SYSTEM`
- `message`: 人が読める要約（**単一行**、改行や制御文字は空白に置換）

### メッセージ規約
- ACCESS: `GET /path`
- SSR: `render complete /path (842ms)` / `render failed /path`
- API: `HP-0X success (status=200, 420ms)` / `HP-0X failed (status=500)`
- SYSTEM: `Missing env VAR_NAME` / `Unhandled exception`
> 文字数ガード：`message` は**最大 1000 文字**に切り詰め（それ以上は `…`）。

---
## 出力先（サーバーログ）
### 方針
- **既定：標準出力（stdout/stderr）一本化**
    - 12-Factor/コンテナ前提。**ファイル出力は行わない**（ECS等の基盤に集約させる）。
- **収集は基盤任せ**
    - 開発：ターミナル表示
    - 本番（コンテナ）：プラットフォームが収集（例：ECS → CloudWatch Logs、GKE → Cloud Logging など）
### 出力ルール
- **フォーマット**：前章の1行テキスト（`[timestamp] [level] [category] message`）
- **出力先の振り分け**
    - `INFO` / `WARN` → **stdout**
    - `ERROR` / `FATAL` → **stderr**  
        （障害検知ルールを組みやすくするため）
- **環境別の差分**
    - 開発（`NODE_ENV=development`）：`DEBUG`許可、色付けやクエリ表示は任意
    - 本番（`production`）：`DEBUG`無効、**クエリ/PIIは出さない**、1行固定
### 設定（環境変数）
- `LOG_LEVEL`: `info`（既定） / `debug` / `warn` / `error`
- `LOG_ENABLE_ACCESS`: `true|false`（既定 `true`。ACCESSログを抑止したい時に使用）
> これ以上の設定（ファイルパス、ローテーション、JSON出力等）は**今回のスコープ外**。必要になったら拡張。
### 役割分担
- **アプリ側**：規約どおりの1行ログをstdout/stderrに出すだけ
- **インフラ側**：収集・保存・検索・アラート（しきい値はインフラで定義）